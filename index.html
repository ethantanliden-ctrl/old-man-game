<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>多人联机小恐龙</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      border: 2px solid #333;
      background: #eee;
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Firebase 配置
    const firebaseConfig = {
      apiKey: "AIzaSyCfgSlZ9w56txH3UK4iYvMiCbbES_JvLNw",
      authDomain: "my-game-52f18.firebaseapp.com",
      projectId: "my-game-52f18",
      storageBucket: "my-game-52f18.firebasestorage.app",
      messagingSenderId: "407828942891",
      appId: "1:407828942891:web:b27dcb37646a31bc5e5a6e",
      measurementId: "G-TW6LTQHBZB",
      databaseURL: "https://my-game-52f18-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 游戏基本配置
    const canvas = document.createElement("canvas");
    canvas.width = 800;
    canvas.height = 300;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext("2d");

    const gravity = 0.6;
    const jumpPower = -12;
    const ground = 250;

    // 当前玩家 ID
    const playerId = "player_" + Math.floor(Math.random() * 1000000);

    // 本地玩家
    let player = {
      id: playerId,
      x: 50,
      y: ground,
      vy: 0,
      score: 0,
      color: getRandomColor()
    };

    // 所有玩家
    let players = {};

    // 障碍物
    let obstacles = [];
    let frame = 0;

    // 随机颜色（每个玩家不同颜色）
    function getRandomColor() {
      const colors = ["red", "blue", "green", "purple", "orange"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // 键盘控制
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" && player.y === ground) {
        player.vy = jumpPower;
      }
    });

    // 更新玩家到 Firebase
    function updatePlayer() {
      update(ref(db, "players/" + playerId), {
        x: player.x,
        y: player.y,
        score: player.score,
        color: player.color
      });
    }

    // 移除玩家（关闭页面时）
    window.addEventListener("beforeunload", () => {
      remove(ref(db, "players/" + playerId));
    });

    // 监听所有玩家
    onValue(ref(db, "players"), (snapshot) => {
      players = snapshot.val() || {};
    });

    // 游戏循环
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 绘制地面
      ctx.fillStyle = "#444";
      ctx.fillRect(0, ground + 30, canvas.width, 10);

      // 玩家物理
      player.vy += gravity;
      player.y += player.vy;
      if (player.y > ground) {
        player.y = ground;
        player.vy = 0;
      }

      // 更新分数
      player.score++;
      updatePlayer();

      // 绘制所有玩家
      for (let id in players) {
        let p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y - 40, 30, 40);
        ctx.fillText(`ID:${id} 分数:${p.score}`, p.x - 10, p.y - 50);
      }

      // 生成障碍物
      if (frame % 100 === 0) {
        obstacles.push({ x: canvas.width, y: ground, w: 20, h: 40 });
      }

      // 更新障碍物
      ctx.fillStyle = "black";
      for (let i = 0; i < obstacles.length; i++) {
        let ob = obstacles[i];
        ob.x -= 5;
        ctx.fillRect(ob.x, ob.y - ob.h, ob.w, ob.h);

        // 碰撞检测（只检测本地玩家）
        if (
          player.x < ob.x + ob.w &&
          player.x + 30 > ob.x &&
          player.y < ob.y &&
          player.y + 40 > ob.y - ob.h
        ) {
          alert("游戏结束！得分: " + player.score);
          remove(ref(db, "players/" + playerId));
          window.location.reload();
        }
      }

      frame++;
      requestAnimationFrame(gameLoop);
    }

    // 初始化数据库中本地玩家
    set(ref(db, "players/" + playerId), player);

    // 开始游戏
    gameLoop();
  </script>
</head>
<body>
</body>
</html>





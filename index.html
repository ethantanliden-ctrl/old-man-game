<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>小恐龙（联机版）</title>
  <style>
    :root{--bg:#f7f7f7;--ground:#444;--dino:#222;--ob:#333;--accent:#08c}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Roboto,"Segoe UI",sans-serif;background:var(--bg);color:#111}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:900px;background:#fff;border-radius:12px;box-shadow:0 8px 30px rgba(12,12,12,0.08);padding:24px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .controls{margin-left:auto;font-size:13px;color:#666}
    canvas{display:block;width:100%;height:auto;border-radius:6px;background:linear-gradient(#dfe7ef,#f6fbff);box-shadow:inset 0 -12px 0 rgba(0,0,0,0.02);}
    .info{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .score{font-weight:700;color:var(--accent)}
    .btn{border:0;padding:8px 12px;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .help{font-size:13px;color:#666}
    .join-box{margin-bottom:16px}
    input{padding:6px;border:1px solid #ccc;border-radius:6px;margin-right:8px}
    @media (max-width:520px){.card{padding:16px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>小恐龙（多人联机版）</h1>
        <div class="controls">空格/↑ 跳跃 · ↓ 下蹲</div>
      </header>

      <div class="join-box">
        <input id="roomId" placeholder="房间号">
        <input id="playerName" placeholder="昵称">
        <button class="btn" id="joinBtn">加入房间</button>
      </div>

      <canvas id="game" width="900" height="260"></canvas>

      <div class="info">
        <div class="help">按 R 或 点击画布重新开始</div>
        <div>
          <span class="score" id="score">分数 0</span>
          <button class="btn" id="restart">重新开始</button>
        </div>
      </div>
    </div>
  </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// 初始化 Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBylbQlZZ7Xo8qEPtoa39Ey3QBxpkcP4_k",
  authDomain: "dino-game-3ed81.firebaseapp.com",
  projectId: "dino-game-3ed81",
  storageBucket: "dino-game-3ed81.firebasestorage.app",
  messagingSenderId: "580049109346",
  appId: "1:580049109346:web:d7091eacedebcd5d076c3b",
  measurementId: "G-9R5G3R7PR5",
  databaseURL: "https://dino-game-3ed81-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let roomId = null;
let playerId = null;
let playerName = null;
let isHost = false;

document.getElementById("joinBtn").onclick = () => {
  roomId = document.getElementById("roomId").value || "default";
  playerName = document.getElementById("playerName").value || ("玩家" + Math.floor(Math.random()*1000));
  playerId = "p" + Math.random().toString(36).slice(2,8);
  joinRoom(roomId, playerId, playerName);
};

function joinRoom(roomId, playerId, name){
  const playersRef = db.ref("rooms/"+roomId+"/players");
  playersRef.child(playerId).set({
    name: name,
    score: 0,
    x: 60,
    y: 200
  });
  playersRef.child(playerId).onDisconnect().remove();

  // 确定房主（第一个人就是 host）
  db.ref("rooms/"+roomId+"/host").transaction(curr=>{
    if(curr===null) return playerId;
    return curr;
  }).then(res=>{
    if(res.snapshot.val()===playerId) isHost = true;
  });

  listenRoom();
}

function listenRoom(){
  // 玩家同步
  db.ref("rooms/"+roomId+"/players").on("value", snap=>{
    remotePlayers = snap.val()||{};
  });
  // 障碍同步
  db.ref("rooms/"+roomId+"/obstacles").on("value", snap=>{
    obstacles = snap.val()?Object.values(snap.val()):[];
  });
}

// ---- 游戏逻辑（原版基础上加了同步） ----
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let running=false, gameOver=false, score=0, speed=6, lastTime=0;
let obstacles=[], clouds=[];
const groundY=200;
const dino={x:60,y:groundY,w:44,h:44,vy:0,gravity:0.9,jumpPower:-13,ducking:false,
  onGround(){return this.y>=groundY}
};
let remotePlayers={};

function tryJump(){ if(dino.onGround() && !dino.ducking){ dino.vy=dino.jumpPower; } }
function rectsOverlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

function loop(ts){
  const dt=Math.min((ts-lastTime)/16.67,3); lastTime=ts;
  // 移动云
  clouds.forEach(c=>c.x-=c.speed*(speed/6));
  clouds=clouds.filter(c=>c.x+c.w>-50);
  if(Math.random()<0.01) clouds.push({x:canvas.width,y:30+Math.random()*60,w:60,speed:1});

  // host 生成障碍并写入数据库
  if(isHost && Math.random()<0.02){
    const obs={x:canvas.width,y:groundY-40,w:30,h:40};
    db.ref("rooms/"+roomId+"/obstacles").push(obs);
  }
  obstacles.forEach(o=>o.x-=speed*dt*8);

  // 控制
  if(keys['Space']||keys['ArrowUp']) tryJump();
  if(keys['ArrowDown']) dino.ducking=true; else dino.ducking=false;
  dino.y+=dino.vy; dino.vy+=dino.gravity*dt;
  if(dino.y>groundY) {dino.y=groundY; dino.vy=0;}

  // 碰撞检测
  const drect={x:dino.x,y:dino.y,w:dino.w,h:dino.ducking?dino.h*0.6:dino.h};
  for(const o of obstacles){
    if(rectsOverlap(drect,o)){running=false;gameOver=true;}
    if(!o.passed&&o.x+o.w<dino.x){o.passed=true;score+=10;
      document.getElementById("score").textContent="分数 "+score;
      db.ref("rooms/"+roomId+"/players/"+playerId+"/score").set(score);
    }
  }

  // 上传玩家状态
  if(roomId&&playerId){
    db.ref("rooms/"+roomId+"/players/"+playerId).update({x:dino.x,y:dino.y,score:score});
  }

  draw();
  if(!gameOver) requestAnimationFrame(loop);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#eee";ctx.fillRect(0,0,canvas.width,canvas.height);
  // 画障碍
  ctx.fillStyle="#333";
  obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));
  // 自己
  ctx.fillStyle="#222";
  ctx.fillRect(dino.x,dino.y,dino.w,dino.h);
  // 其他玩家
  ctx.fillStyle="blue";
  for(const id in remotePlayers){
    if(id!==playerId){
      const p=remotePlayers[id];
      ctx.fillRect(p.x||0,p.y||200,30,30);
      ctx.fillText(p.name, (p.x||0), (p.y||200)-6);
    }
  }
}

function start(){if(running)return;running=true;gameOver=false;score=0;lastTime=performance.now();requestAnimationFrame(loop);}
function reset(){running=false;gameOver=false;score=0;obstacles=[];clouds=[];dino.y=groundY;dino.vy=0;document.getElementById("score").textContent="分数 0";}

document.getElementById("restart").onclick=()=>{reset();start();};
canvas.onclick=()=>{if(gameOver){reset();start();}};

// 控制
const keys={};
window.onkeydown=e=>{keys[e.code]=true;if(!running)start();if(gameOver&&e.key.toLowerCase()==='r'){reset();start();}};
window.onkeyup=e=>keys[e.code]=false;
</script>
</body>
</html>

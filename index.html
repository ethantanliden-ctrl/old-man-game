<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¤šäººè”æœºå°æé¾™</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      border: 2px solid #333;
      background: #eee;
    }
    #leaderboard {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
      min-width: 150px;
    }
    #leaderboard h3 {
      margin: 0 0 5px;
      font-size: 16px;
      text-align: center;
      color: gold;
    }
    #leaderboard ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #leaderboard li {
      margin: 3px 0;
    }
  </style>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyCfgSlZ9w56txH3UK4iYvMiCbbES_JvLNw",
      authDomain: "my-game-52f18.firebaseapp.com",
      projectId: "my-game-52f18",
      storageBucket: "my-game-52f18.firebasestorage.app",
      messagingSenderId: "407828942891",
      appId: "1:407828942891:web:b27dcb37646a31bc5e5a6e",
      measurementId: "G-TW6LTQHBZB",
      databaseURL: "https://my-game-52f18-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    // ğŸ® å½“å‰æˆ¿é—´ IDï¼ˆå›ºå®š room1ï¼Œä½ ä¹Ÿå¯ä»¥ä»¥åæ”¹æˆç©å®¶è¾“å…¥ï¼‰
    const roomId = "room1";

    // æ¸¸æˆåŸºæœ¬é…ç½®
    const canvas = document.createElement("canvas");
    canvas.width = 800;
    canvas.height = 300;
    document.body.appendChild(canvas);
    const ctx = canvas.getContext("2d");

    const gravity = 0.6;
    const jumpPower = -12;
    const ground = 250;

    // å½“å‰ç©å®¶ IDï¼ˆä½¿ç”¨ Firebase åŒ¿åç™»å½•ç”Ÿæˆçš„ UIDï¼‰
    let playerId = null;

    // æœ¬åœ°ç©å®¶
    let player = null;

    // æ‰€æœ‰ç©å®¶
    let players = {};

    // éšœç¢ç‰©
    let obstacles = [];
    let frame = 0;

    // ğŸ¯ æ’è¡Œæ¦œ DOM
    const leaderboardDiv = document.createElement("div");
    leaderboardDiv.id = "leaderboard";
    leaderboardDiv.innerHTML = "<h3>æ’è¡Œæ¦œ</h3><ul id='rankList'></ul>";
    document.body.appendChild(leaderboardDiv);
    const rankList = document.getElementById("rankList");

    // éšæœºé¢œè‰²ï¼ˆæ¯ä¸ªç©å®¶ä¸åŒé¢œè‰²ï¼‰
    function getRandomColor() {
      const colors = ["red", "blue", "green", "purple", "orange"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // é”®ç›˜æ§åˆ¶
    document.addEventListener("keydown", (e) => {
      if (e.code === "Space" && player && player.y === ground) {
        player.vy = jumpPower;
      }
    });

    // æ›´æ–°ç©å®¶åˆ° Firebase
    function updatePlayer() {
      if (!playerId || !player) return;
      update(ref(db, `rooms/${roomId}/players/${playerId}`), {
        x: player.x,
        y: player.y,
        score: player.score,
        color: player.color
      });
    }

    // ç§»é™¤ç©å®¶ï¼ˆå…³é—­é¡µé¢æ—¶ï¼‰
    window.addEventListener("beforeunload", () => {
      if (playerId) {
        remove(ref(db, `rooms/${roomId}/players/${playerId}`));
      }
    });

    // ç›‘å¬æˆ¿é—´å†…æ‰€æœ‰ç©å®¶
    onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
      players = snapshot.val() || {};
    });

    // ğŸ¯ ç›‘å¬æ’è¡Œæ¦œ
    onValue(ref(db, "highScores"), (snapshot) => {
      const scores = snapshot.val() || {};
      const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]).slice(0, 5);
      rankList.innerHTML = "";
      sorted.forEach(([id, score], idx) => {
        const li = document.createElement("li");
        li.textContent = `${idx + 1}. ${id.slice(0,6)} - ${score}`;
        rankList.appendChild(li);
      });
    });

    // æ¸¸æˆå¾ªç¯
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶åœ°é¢
      ctx.fillStyle = "#444";
      ctx.fillRect(0, ground + 30, canvas.width, 10);

      if (player) {
        // ç©å®¶ç‰©ç†
        player.vy += gravity;
        player.y += player.vy;
        if (player.y > ground) {
          player.y = ground;
          player.vy = 0;
        }

        // æ›´æ–°åˆ†æ•°ï¼ˆæ¯30å¸§ä¸€æ¬¡ï¼‰
        if (frame % 30 === 0) {
          player.score++;
          updatePlayer();
        }
      }

      // ç»˜åˆ¶æ‰€æœ‰ç©å®¶
      ctx.font = "14px Arial";
      for (let id in players) {
        let p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y - 40, 30, 40);
        ctx.fillStyle = "black";
        ctx.fillText(`ID:${id.slice(0,6)} åˆ†æ•°:${p.score}`, p.x - 10, p.y - 50);
      }

      // ç”Ÿæˆéšœç¢ç‰©
      if (frame % 100 === 0) {
        obstacles.push({ x: canvas.width, y: ground, w: 20, h: 40 });
      }

      // æ›´æ–°éšœç¢ç‰©
      ctx.fillStyle = "black";
      for (let i = 0; i < obstacles.length; i++) {
        let ob = obstacles[i];
        ob.x -= 5;
        ctx.fillRect(ob.x, ob.y - ob.h, ob.w, ob.h);

        // ç¢°æ’æ£€æµ‹ï¼ˆåªæ£€æµ‹æœ¬åœ°ç©å®¶ï¼‰
        if (
          player &&
          player.x < ob.x + ob.w &&
          player.x + 30 > ob.x &&
          player.y < ob.y &&
          player.y + 40 > ob.y - ob.h
        ) {
          alert("æ¸¸æˆç»“æŸï¼å¾—åˆ†: " + player.score);

          // ğŸ¯ ä¿å­˜åˆ°æ’è¡Œæ¦œ
          update(ref(db, `highScores/${playerId}`), player.score);

          remove(ref(db, `rooms/${roomId}/players/${playerId}`));
          window.location.reload();
        }
      }

      frame++;
      requestAnimationFrame(gameLoop);
    }

    // âœ… ä½¿ç”¨ Firebase åŒ¿åç™»å½•è·å– UID
    signInAnonymously(auth)
      .then(() => {
        playerId = auth.currentUser.uid; // Firebase åˆ†é…çš„å”¯ä¸€ ID
        player = {
          id: playerId,
          x: 50 + Math.floor(Math.random() * 200), // éšæœºåˆå§‹ä½ç½®
          y: ground,
          vy: 0,
          score: 0,
          color: getRandomColor()
        };

        // åˆå§‹åŒ–æ•°æ®åº“ä¸­æœ¬åœ°ç©å®¶
        set(ref(db, `rooms/${roomId}/players/${playerId}`), player);

        // å¼€å§‹æ¸¸æˆ
        gameLoop();
      })
      .catch((error) => {
        console.error("åŒ¿åç™»å½•å¤±è´¥:", error);
      });
  </script>
</head>
<body>
</body>
</html>


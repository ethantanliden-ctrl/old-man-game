<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>小恐龙游戏 - 联机版</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
    }
    canvas {
      border: 2px solid #333;
      background: #fff;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // === Firebase 配置 ===
    const firebaseConfig = {
      apiKey: "AIzaSyCfgSlZ9w56txH3UK4iYvMiCbbES_JvLNw",
      authDomain: "my-game-52f18.firebaseapp.com",
      databaseURL: "https://my-game-52f18-default-rtdb.firebaseio.com",
      projectId: "my-game-52f18",
      storageBucket: "my-game-52f18.appspot.com",
      messagingSenderId: "407828942891",
      appId: "1:407828942891:web:b27dcb37646a31bc5e5a6e",
      measurementId: "G-TW6LTQHBZB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    // === 游戏变量 ===
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 300;

    let playerId;
    let players = {}; // 存所有玩家

    // === 玩家对象 ===
    function createPlayer(x, y, color = "green") {
      return { x, y, vy: 0, width: 40, height: 40, color, score: 0 };
    }

    // 本地玩家
    let localPlayer = createPlayer(50, canvas.height - 60, "red");

    // === Firebase 登录 ===
    signInAnonymously(auth).then(() => {
      playerId = "player_" + Math.floor(Math.random() * 10000);
      console.log("登录成功:", playerId);

      // 初始化上传自己
      set(ref(db, "rooms/room1/players/" + playerId), {
        x: localPlayer.x,
        y: localPlayer.y,
        score: 0,
        color: localPlayer.color
      });

      // 退出清除
      window.addEventListener("beforeunload", () => {
        remove(ref(db, "rooms/room1/players/" + playerId));
      });

      // 监听所有玩家
      onValue(ref(db, "rooms/room1/players"), (snapshot) => {
        players = snapshot.val() || {};
      });
    });

    // === 控制 ===
    document.addEventListener("keydown", e => {
      if (e.code === "Space" || e.code === "ArrowUp") {
        if (localPlayer.y >= canvas.height - 60) {
          localPlayer.vy = -12;
        }
      }
    });

    // === 游戏循环 ===
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 更新本地玩家物理
      localPlayer.y += localPlayer.vy;
      localPlayer.vy += 0.6;
      if (localPlayer.y > canvas.height - 60) {
        localPlayer.y = canvas.height - 60;
        localPlayer.vy = 0;
      }

      localPlayer.score++;

      // 把自己状态写到 Firebase
      if (playerId) {
        set(ref(db, "rooms/room1/players/" + playerId), {
          x: localPlayer.x,
          y: localPlayer.y,
          score: localPlayer.score,
          color: localPlayer.color
        });
      }

      // 绘制所有玩家
      for (let id in players) {
        const p = players[id];
        ctx.fillStyle = p.color || "green";
        ctx.fillRect(p.x, p.y, 40, 40);
        ctx.fillStyle = "black";
        ctx.fillText(id, p.x, p.y - 5);
        ctx.fillText("Score: " + p.score, p.x, p.y - 20);
      }

      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
</body>
</html>
